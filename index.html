<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Web Painter</title>
  <script src="js/require.js"></script>
  <script src="js/zrender.js"></script>
  <script src="js/jquery-1.11.2.js"></script>
  <script src="js/triangle.js"></script>
</head>
<body>
  <input type="button" value="pointer" id="pointer"/>
  <input type="button" value="line" id="line"/>
  <input type="button" value="curve" id="curve" />
  <div id="main" style="width:100%;height:500px;border:1px solid #ccc"></div>
</body>
<script type="text/javascript">
require.config({
  paths:{
    zrender : './js/zrender',
    'zrender/shape/Circle' : './js/zrender',
    'zrender/shape/Line' : './js/zrender',
  }
});

// Step:4 require zrender and use it in the callback.
// Step:4 动态加载zrender然后在回调函数中开始使用
require(
  ['zrender','zrender/shape/Circle','zrender/shape/Line', 'zrender/shape/BezierCurve'],
  function(zrender) {
    var zr = zrender.init(document.getElementById('main'));
    var Circle = require('zrender/shape/Circle');
    var Line = require('zrender/shape/Line');
    var Curve = require('zrender/shape/BezierCurve');

    var draggingPointStyle = {
      r : 5,
      color : "white",
      brushType : "both",
      strokeColor : "black",
      lineWidth : 1
    };

    var location =  {
      x : 1,
      y : 1
    }

    var temp = $.extend(draggingPointStyle,location);

    function EditableLine(){
      var p_start;
      var p_end;

      var _this = this;
      var drawFunction = function(params){
        _this.p_end.style.x = params.event.offsetX;
        _this.p_end.style.y = params.event.offsetY;
        zr.modShape(_this.p_end);
        _this.newLine.style.xEnd = _this.p_end.style.x;
        _this.newLine.style.yEnd = _this.p_end.style.y;
        zr.modShape(_this.newLine);
      }

      var drawingFlag = false;

      var drawLine = function(params){
        drawingFlag = true;
        zr.on('mousemove', drawFunction);

        _this.p_start = new Circle({
          style: {
            x : params.event.offsetX,
            y : params.event.offsetY,
            r : 5,
            color : "white",
            brushType : "both",
            strokeColor : "black",
            lineWidth : 1
          },
          clickable: true,
          onmousedown: function(params){
            zr.on('mousemove', function(params){
              var targetX = params.event.offsetX;
              var targetY = params.event.offsetY;
              _this.p_start.style.x = targetX
              _this.p_start.style.y = targetY
              zr.modShape(_this.p_start)
              _this.newLine.style.xStart = targetX
              _this.newLine.style.yStart = targetY;
              zr.modShape(_this.newLine)
            });
          },
          onmouseup : function(params){
            onmousemove = null;
          }
        });

        _this.p_end = new Circle({
          style: {
            x : params.event.offsetX,
            y : params.event.offsetY,
            r : 5,
            color : "white",
            brushType : "both",
            strokeColor : "black",
            lineWidth : 1
          },
          onmousedown: function(params){
            zr.on('mousemove', function(params){
              var targetX = params.event.offsetX;
              var targetY = params.event.offsetY;
              _this.p_end.style.x = targetX
              _this.p_end.style.y = targetY
              zr.modShape(_this.p_end)
              _this.newLine.style.xEnd = targetX
              _this.newLine.style.yEnd = targetY;
              zr.modShape(_this.newLine)
            });
          },
          onmouseup : function(params){
            onmousemove = null;
          }
        });

        var newLineStyle = {
          clickable: true,
          // draggable: true,
          onclick: function(params){

          },
          ondblclick: function(params){
            var targetX = params.event.offsetX;
            var targetY = params.event.offsetY;
            var p_new = new Circle({
              style: {
                x : targetX,
                y : targetY,
                r : 5,
                color : "white",
                brushType : "both",
                strokeColor : "black",
                lineWidth : 1
              },
              draggable: true,
              onmousedown: function(params){
                zr.on('mousemove', function(params){
                  var targetX = params.event.offsetX;
                  var targetY = params.event.offsetY;
                  var offsetX = _this.halfLine.style.xEnd - targetX;
                  var offsetY = _this.halfLine.style.yEnd - targetY;
                  p_anchor1.style.x -= offsetX;
                  p_anchor1.style.y -= offsetY;
                  zr.modShape(p_anchor1);

                  line_anchor1.style.xEnd = targetX;
                  line_anchor1.style.yEnd = targetY;
                  line_anchor1.style.xStart = p_anchor1.style.x;
                  line_anchor1.style.yStart = p_anchor1.style.y;

                  _this.halfLine.style.cpX1 = p_anchor1.style.x;
                  _this.halfLine.style.cpY1 = p_anchor1.style.y;
                  _this.halfLine.style.xEnd = targetX
                  _this.halfLine.style.yEnd = targetY
                  zr.modShape(_this.halfLine)
                  _this.newLine.style.xEnd = targetX
                  _this.newLine.style.yEnd = targetY;
                  zr.modShape(_this.newLine)
                });
              }
            });

            var originalX = this.style.xEnd;
            var originalY = this.style.yEnd;

            var anchor1 = Triangle.findAnchor(p_new.style.x, p_new.style.y, originalX, originalY, 50);
            var p_anchor1 = new Circle({
              style: {
                x : anchor1.x,
                y : anchor1.y,
                r : 5,
                color : "white",
                brushType : "both",
                strokeColor : "black",
                lineWidth : 1
              },
            });

            var line_anchor1 = new Line({
              style:{
                xStart: p_anchor1.style.x,
                yStart: p_anchor1.style.y,
                xEnd: p_new.style.x,
                yEnd: p_new.style.y,
                strokeColor: 'black',
                lineWidth: 2
              }
            });
            zr.addShape(line_anchor1);
            zr.addShape(p_anchor1);

            this.style.xEnd = targetX;
            this.style.yEnd = targetY;
            zr.modShape(this);

            locationOpt = {
              style: {
                xStart: originalX,
                yStart: originalY,
                cpX1 : anchor1.x,
                cpY1 : anchor1.y,
                xEnd: targetX,
                yEnd: targetY,
                strokeColor: 'black',
                lineWidth: 2
              }
            }

            var opt = $.extend(locationOpt, newLineStyle);
            _this.halfLine = new Curve(opt);

            zr.addShape(_this.halfLine);
            zr.addShape(p_new);
          }
        }

        var locationOpt = {
          style:{
            xStart: _this.p_start.style.x,
            yStart: _this.p_start.style.y,
            xEnd: _this.p_end.style.x,
            yEnd: _this.p_end.style.y,
            strokeColor: 'black',
            lineWidth: 2
          }
        }
        var opt = $.extend(locationOpt, newLineStyle);
        _this.newLine = new Line(opt);
        zr.addShape(_this.newLine);
        zr.addShape(_this.p_start);
        zr.addShape(_this.p_end);
      }

      return {
        drawLine : drawLine,
        drawFunction : drawFunction
      }
    };

    $('#line').click(function(){
      var lineBuilder;
      zr.on('mousedown', function(params){
        editableLine = new EditableLine();
        editableLine.drawLine(params);
      });
      zr.on('mouseup', function(){
        zr.un('mousemove');
      });
      $('#pointer').click(function(){
        zr.un('mousedown');
      });
    });


// ========= curve ==========
    // var p1 = new Circle({
    //   style: {
    //     x : 100,
    //     y : 20,
    //     r : 5,
    //     color : "white",
    //     brushType : "both",
    //     strokeColor : "black",
    //     lineWidth : 1
    //   }
    // });
    // zr.addShape(p1);
    // var p2 = new Circle({
    //   style: {
    //     x : 200,
    //     y : 20,
    //     r : 5,
    //     color : "white",
    //     brushType : "both",
    //     strokeColor : "black",
    //     lineWidth : 1
    //   }
    // });
    // zr.addShape(p2);
    //
    // var cp = new Circle({
    //   style:{
    //     x : 150,
    //     y : 100,
    //     r : 5,
    //     color : "white",
    //     brushType : "both",
    //     strokeColor : "black",
    //     lineWidth : 1
    //   },
    //   draggable: true,
    //   onmousedown: function(params){
    //     var CP1OffsetX = cp1.style.x - cp.style.x;
    //     var CP1OffsetY = cp1.style.y - cp.style.y;
    //     var _this = this;
    //     onmousemove = function(mme){
    //       var targetX = mme.offsetX;
    //       var targetY = mme.offsetY;
    //       cp1.style.x = targetX + CP1OffsetX;
    //       cp1.style.y = targetY + CP1OffsetY;
    //       zr.modShape(cp1);
    //       curve1.style.cpX1 = cp1.style.x
    //       curve1.style.cpY1 = cp1.style.y
    //       curve1.style.xEnd = targetX
    //       curve1.style.yEnd = targetY
    //       zr.modShape(line1)
    //     }
    //   },
    //   onmouseup : function(params){
    //     onmousemove = null;
    //   }
    // })
    // zr.addShape(cp);
    //
    // var cp1 = new Circle({
    //   style:{
    //     x : 120,
    //     y : 100,
    //     r : 5,
    //     color : "white",
    //     brushType : "both",
    //     strokeColor : "black",
    //     lineWidth : 1
    //   },
    //   draggable: true,
    //   onmousedown: function(params){
    //     var _this = this;
    //     onmousemove = function(mme){
    //       var targetX = mme.offsetX;
    //       var targetY = mme.offsetY;
    //       curve1.style.cpX1 = targetX
    //       curve1.style.cpY1 = targetY;
    //       zr.modShape(line1)
    //     }
    //   },
    //   onmouseup : function(params){
    //     onmousemove = null;
    //   }
    // })
    // zr.addShape(cp1);
    // var cp2 = new Circle({
    //   style: {
    //     x : 180,
    //     y : 100,
    //     r : 5,
    //     color : "white",
    //     brushType : "both",
    //     strokeColor : "black",
    //     lineWidth : 1
    //   }
    // });
    // zr.addShape(cp2);
    //
    // var lineCPCP1 = new Line({
    //   style: {
    //     xStart: cp.style.x,
    //     yStart: cp.style.y,
    //     xEnd: cp1.style.x,
    //     yEnd: cp1.style.y,
    //     strokeColor: 'black',
    //     lineWidth: 2
    //   }
    // });
    // zr.addShape(lineCPCP1)
    //
    // var lineCPCP2 = new Line({
    //   style: {
    //     xStart: cp.style.x,
    //     yStart: cp.style.y,
    //     xEnd: cp2.style.x,
    //     yEnd: cp2.style.y,
    //     strokeColor: 'black',
    //     lineWidth: 2
    //   }
    // });
    // zr.addShape(lineCPCP2)
    //
    // var curve1 = new Curve({
    //   style : {
    //     xStart : p1.style.x,
    //     yStart : p1.style.y,
    //     cpX1 : cp1.style.x,
    //     cpY1 : cp1.style.y,
    //     xEnd : cp.style.x,
    //     yEnd : cp.style.y,
    //     strokeColor : "black",
    //     lineWidth : 2,
    //   }
    // });
    // zr.addShape(curve1);
    //
    // var curve2 = new Curve({
    //   style : {
    //     xStart : cp.style.x,
    //     yStart : cp.style.y,
    //     cpX1 : cp2.style.x,
    //     cpY1 : cp2.style.y,
    //     xEnd : p2.style.x,
    //     yEnd : p2.style.y,
    //     strokeColor : "black",
    //     lineWidth : 2,
    //   }
    // });
    // zr.addShape(curve2);
  });
</script>
</html>
